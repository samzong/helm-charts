name: PR Chart Checks

on:
  pull_request:
    paths:
      - "charts/**"
      - "scripts/**"
      - ".github/workflows/**"

jobs:
  lint-and-render:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Determine changed charts
        id: changes
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          mapfile -t charts < <(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^charts/' | cut -d'/' -f1-2 | sort -u || true)
          if [ ${#charts[@]} -eq 0 ]; then
            echo "changed=false" >>"$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >>"$GITHUB_OUTPUT"
          printf '%s\n' "${charts[@]}" > changed_charts.txt

      - name: Update Helm dependencies
        if: steps.changes.outputs.changed == 'true'
        run: |
          set -euo pipefail
          while read -r chart; do
            if [ ! -f "$chart/Chart.yaml" ]; then
              echo "::warning::Skipping dependency update for $chart: Chart.yaml not found"
              continue
            fi
            echo "Updating dependencies for $chart"
            output=$(helm dependency update "$chart" 2>&1) || {
              echo "::error::Failed to update dependencies for $chart"
              echo "$output"
              exit 1
            }
            echo "$output" | grep -v "nothing to update" || true
          done < changed_charts.txt

      - name: Helm lint
        if: steps.changes.outputs.changed == 'true'
        run: |
          set -euo pipefail
          while read -r chart; do
            if [ ! -f "$chart/Chart.yaml" ]; then
              echo "::warning::Skipping lint for $chart: Chart.yaml not found"
              continue
            fi
            echo "Linting $chart"
            if ! helm lint "$chart"; then
              echo "::error::Lint failed for $chart"
              exit 1
            fi
          done < changed_charts.txt

      - name: Helm template dry-run
        if: steps.changes.outputs.changed == 'true'
        run: |
          set -euo pipefail
          while read -r chart; do
            if [ ! -f "$chart/Chart.yaml" ]; then
              echo "::warning::Skipping template render for $chart: Chart.yaml not found"
              continue
            fi
            echo "Rendering $chart"
            if ! helm template pr-check "$chart" --namespace pr-check; then
              echo "::error::Template render failed for $chart"
              exit 1
            fi
          done < changed_charts.txt

      - name: No chart changes detected
        if: steps.changes.outputs.changed != 'true'
        run: echo "No chart directories modified; skipping Helm checks."
